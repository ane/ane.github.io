<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

        <title>
            
            Antoine Kalmbach
            
        </title>

        
        <meta name="description" content="The personal blog of Antoine Kalmbach, a Finnish-French software engineer.">
        
        <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">

        <link type="application/atom+xml" rel="alternate" href="http://ane.github.io/feed.xml" title="Antoine Kalmbach">
        <meta charset="utf-8">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Home - Antoine Kalmbach</title>
<meta property="og:title" content="Home">
<meta name="description" content="Antoine Kalmbach’s Blog">
<meta property="og:description" content="Antoine Kalmbach’s Blog">
<link rel="canonical" href="http://ane.github.io/">
<meta property="og:url" content="http://ane.github.io/">
<meta property="og:site_name" content="Antoine Kalmbach">
<link rel="next" href="http://ane.github.io/page2">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@anewtf">
<meta name="twitter:creator" content="@Antoine Kalmbach">
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Antoine Kalmbach",
    "headline": "Home",
    "description": "Antoine Kalmbach’s Blog",
    "url": "http://ane.github.io/"
  }
</script>
<!-- End Jekyll SEO tag -->
        <link href="https://fonts.googleapis.com/css?family=PT+Serif%7COpen+Sans" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/css/bootstrap.min.css" integrity="sha384-2hfp1SzUoho7/TsGGGDaFdsuuDL0LX2hnUp6VkX3CUQ2K4K+xjboZdsXyp4oUHZj" crossorigin="anonymous">
        <link rel="stylesheet" href="/assets/override.css">
        <link rel="stylesheet" href="/assets/pygments.css">

    </head>
    <body class="home-template">
        <div class="hyphenate">
            <header class="main-header">
    <nav id="topnav" class="navbar navbar-full navbar-light bg-faded">
        <div class="container">
            <a class="navbar-brand" href="http://ane.github.io">Antoine Kalmbach</a>
            <button class="navbar-toggler hidden-sm-up" type="button" data-toggle="collapse" data-target="#collapse-navbar">
                ☰
            </button>
            <div class="collapse navbar-toggleable-xs" id="collapse-navbar">
                <ul class="nav navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/meta.html">Meta</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/feed.xml">Subscribe</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>


            <div class="container">
                <div class="content">
                    <div>
    
    <div class="row">
        <div class="col-sm-9">
    
    
    <article class="post">
        
<header>
    <h2 class="page-header">
        <a class="post-title" href="/2016/10/17/streaming-http-requests.html">Streaming HTTP requests in akka-http</a>
    </h2>
    <p>
        <time class="text-muted post-meta" datetime="2016-10-17">
            October 17, 2016
             — Tagged as <a href="/tags/scala">scala</a>, <a href="/tags/akka">akka</a>, <a href="/tags/reactive-streams">reactive-streams</a>
        </time>
    </p>
</header>

        <figure class="figure pull-md-right m-l-2">
<img src="/images/streaming-http/first.png" class="figure-img img-fluid">
<figcaption class="figure-caption">Figure 1. Input sources to an application</figcaption>
</figure>

<p><a href="http://doc.akka.io/docs/akka/2.4/scala/stream/index.html">Akka streams</a> is the
<a href="http://doc.akka.io/docs/akka/2.4/scala/stream/index.html">reactive streams</a> implementation of the
<a href="http://akka.io">Akka toolkit</a>. It lets you model computations as data flows while abstracting away
the underlying concurrency and parallelism. That is to say, the developer is free to model the data
in a computation as a <em>flow</em> of data from one place to another. Now, while this is an exciting
subject by itself, this post isn’t about reactive programming, but a particular use case for it. I
assume some familiarity with reactive programming and the terms Akka Streams uses, so if you find
some of the terms confusing, refer to the Akka documentation for more information. To those familiar
with the former but not with the latter, a Flow is a Processor.</p>

<h2 id="problem-description">Problem description</h2>

<p>Our particular quandary is that we want to build an application (see Figure 1) which consists of a
unidirectional datastream from a set of input sources (files, a message queue, a HTTP interface),
propagating them from <code class="highlighter-rouge">A</code> to <code class="highlighter-rouge">C</code>, and so on.</p>

<p>If we build this as a Akka Strems flow, conceptually, it could look like this:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="c1">// the sink
</span><span class="k">val</span> <span class="n">sink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>

<span class="c1">// a silly flow
</span><span class="k">val</span> <span class="n">flow</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">)</span>

<span class="c1">// our sources
</span><span class="k">val</span> <span class="n">mq</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">single</span><span class="o">(</span><span class="s">"hi from mq"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">rest</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">single</span><span class="o">(</span><span class="s">"hi from rest api"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">file</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">.</span><span class="n">single</span><span class="o">(</span><span class="s">"hi from a file"</span><span class="o">)</span>

<span class="c1">// run sources to the sink
</span><span class="n">mq</span><span class="o">.</span><span class="n">via</span><span class="o">(</span><span class="n">flow</span><span class="o">).</span><span class="n">runWith</span><span class="o">(</span><span class="n">sink</span><span class="o">)</span>
<span class="n">rest</span><span class="o">.</span><span class="n">via</span><span class="o">(</span><span class="n">flow</span><span class="o">).</span><span class="n">runWith</span><span class="o">(</span><span class="n">sink</span><span class="o">)</span>
<span class="n">file</span><span class="o">.</span><span class="n">via</span><span class="o">(</span><span class="n">flow</span><span class="o">).</span><span class="n">runWith</span><span class="o">(</span><span class="n">sink</span><span class="o">)</span>
</code></pre>
</div>

<p>The thing to remember is that internally this code does <strong>not</strong> look like the things in Figure 1, at
all. This is because these flow stages are blueprints: they describe how inputs are connected to
outputs, but it is not as if the <code class="highlighter-rouge">sink</code> is concretely targeted as a value. It is simply a building
block that is used in an actual flow. It is the actual call to <code class="highlighter-rouge">runWith</code> that produces a computation
– materializing a value – but not the actual <code class="highlighter-rouge">Sink</code> itself.</p>

<p>It is particularly easy to construct a <code class="highlighter-rouge">Source[T, ...]</code> from a message queue and a file, but the
HTTP part is tricky. The thing to remember is that the <em>above code does not do anything</em>: it is
simply a <em>blueprint</em> of a reactive program. It says “wire these sources together, merge their
outputs, send them to A, and from there finally to C”, but it doesn’t do anything until we
<em>materialize</em> it.</p>

<figure class="figure pull-md-right m-l-2">
<img src="/images/streaming-http/second.png" class="figure-img img-fluid">
<figcaption class="figure-caption">Figure 2. Hooking our flow to the HTTP server flow.</figcaption>
</figure>

<p>This is where akka-http jumps in. In akka-http, a web server consists, at a low level, from
a <code class="highlighter-rouge">Flow[HttpRequest, HttpResponse, NotUsed]</code>. We are interested in getting our <code class="highlighter-rouge">Message</code> elements
out of the <code class="highlighter-rouge">HttpRequest</code> and propagating them further downstream, and not particularly interested in
giving the HTTP client anything more descriptive than a <code class="highlighter-rouge">HTTP 201 Created</code>.</p>

<p>If we wire our flow as a part of this flow, still, <em>nothing happens</em>, because it’s a blueprint. The
blueprint gets materialized into a flow when a HTTP connection comes, and once the connection dies,
the flow dies. So even if we manage to hook our flow as a part of the HTTP server flow like in
Figure 2, we end up destroying every the main flow once every HTTP request ends. This demonstrated
by the following snippet:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
<span class="k">import</span> <span class="nn">akka.http.scaladsl.Http</span>
<span class="k">import</span> <span class="nn">akka.http.scaladsl.model.</span><span class="o">{</span><span class="nc">HttpRequest</span><span class="o">,</span> <span class="nc">HttpResponse</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">akka.stream.ActorMaterializer</span>
<span class="k">import</span> <span class="nn">akka.stream.scaladsl.</span><span class="o">{</span><span class="nc">Flow</span><span class="o">,</span> <span class="nc">Sink</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">akka.util.ByteString</span>
<span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="nc">Done</span><span class="o">,</span> <span class="nc">NotUsed</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.typesafe.scalalogging.StrictLogging</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span>       <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()</span>

<span class="k">import</span> <span class="nn">system.dispatcher</span>
</code></pre>
</div>
<p>This brings us the necessary elements into view. First, we need the final stage of the flow,
the sink. It materializes into a <code class="highlighter-rouge">Future[Done]</code> which will complete when the stream completes.</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="c1">// the sink
</span><span class="k">val</span> <span class="n">sink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">msg</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span>
</code></pre>
</div>

<p>Next, a simple appender processing stage.</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="c1">// the processing Flow in the middle
</span><span class="k">val</span> <span class="n">flow</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">).</span><span class="n">log</span><span class="o">(</span><span class="s">"middle-flow"</span><span class="o">)</span>
</code></pre>
</div>

<p>Here’s the funny part: we need to extract the data inside the <code class="highlighter-rouge">HttpEntity</code>, but as that is a
<code class="highlighter-rouge">Source[ByteString, ...]</code> we complete that source by folding its contents into a string. Looks more
complicated than it is in reality. Actual unmarshalling is a lot simpler than this.</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="c1">// turn requests into messages
</span><span class="k">val</span> <span class="n">toMsg</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">HttpRequest</span>, <span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Flow</span><span class="o">[</span><span class="kt">HttpRequest</span><span class="o">]</span>
    <span class="o">.</span><span class="n">mapAsync</span><span class="o">(</span><span class="mi">1</span><span class="o">)(</span><span class="n">req</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">content</span> <span class="k">=</span> <span class="n">req</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">dataBytes</span><span class="o">.</span><span class="n">runFold</span><span class="o">(</span><span class="nc">ByteString</span><span class="o">.</span><span class="n">empty</span><span class="o">)(</span><span class="k">_</span> <span class="o">++</span> <span class="k">_</span><span class="o">)</span>

        <span class="n">content</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">decodeString</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">))</span>
    <span class="o">})</span>
    <span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="s">"to-msg"</span><span class="o">)</span>
</code></pre>
</div>

<p>Hooking the flows together couldn’t be simpler: this plugs the <code class="highlighter-rouge">Sink</code> end of the <code class="highlighter-rouge">Flow</code>, creating a <code class="highlighter-rouge">Sink</code>.</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="c1">// hook flows together
</span><span class="k">val</span> <span class="n">msgsToFlow</span> <span class="k">=</span> <span class="n">toMsg</span><span class="o">.</span><span class="n">via</span><span class="o">(</span><span class="n">flow</span><span class="o">).</span><span class="n">to</span><span class="o">(</span><span class="n">sink</span><span class="o">)</span>
</code></pre>
</div>

<p>Now we create the request flow. the <code class="highlighter-rouge">.alsoTo</code> method sends the flow elements to a <code class="highlighter-rouge">Sink</code>, and then
returns the stream, effectively broadcasting the flow to two places. That is the <em>yoink</em> part above.</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="c1">// the request flow, sending also to toMsg
</span><span class="k">val</span> <span class="n">route</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">HttpRequest</span>, <span class="kt">HttpResponse</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Flow</span><span class="o">[</span><span class="kt">HttpRequest</span><span class="o">].</span><span class="n">alsoTo</span><span class="o">(</span><span class="n">msgsToFlow</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">HttpResponse</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span> <span class="n">entity</span> <span class="k">=</span> <span class="s">"Thanks!"</span><span class="o">))</span>
                      <span class="c1">// ^ yoink!
</span>
<span class="c1">// run server
</span><span class="nc">Http</span><span class="o">().</span><span class="n">bindAndHandle</span><span class="o">(</span><span class="n">route</span><span class="o">,</span> <span class="s">"localhost"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">)</span>
</code></pre>
</div>

<p>Running the snippet yields the following:</p>

<div class="language-bash highlighter-rouge">
<pre class="highlight"><code><span class="gp">$ </span>curl -X POST -d<span class="s1">'hello'</span> localhost:8080
Thanks!

... <span class="k">in </span>our application ...
DEBUG akka.io.TcpListener - New connection accepted
DEBUG akka.stream.Materializer - <span class="o">[</span>rest] Element: HttpResponse<span class="o">(</span>200 OK,List<span class="o">()</span>, ...<span class="o">)</span>
DEBUG akka.stream.Materializer - <span class="o">[</span>to-msg] Element: hello
DEBUG akka.stream.Materializer - <span class="o">[</span>middle-flow] Element: hello!
hello!
DEBUG akka.stream.Materializer - <span class="o">[</span>rest] Downstream finished.
DEBUG akka.stream.Materializer - <span class="o">[</span>to-msg] Upstream finished.
DEBUG akka.stream.Materializer - <span class="o">[</span>middle-flow] Upstream finished.
</code></pre>
</div>


         <hr> 
    </article>
    
    
    
    <article class="post">
        
<header>
    <h2 class="page-header">
        <a class="post-title" href="/2016/10/14/communicator-functional-actors.html">Communicators: Actors with purely functional state</a>
    </h2>
    <p>
        <time class="text-muted post-meta" datetime="2016-10-14">
            October 14, 2016
             — Tagged as <a href="/tags/scala">scala</a>, <a href="/tags/akka">akka</a>, <a href="/tags/fp">fp</a>, <a href="/tags/erlang">erlang</a>
        </time>
    </p>
</header>

        <p>In Scala, Akka actors, as in the traditional <a href="http://en.wikipedia.org/wiki/Actor_model">Actor model</a>, may
modify private state. The accepted convention is to have a mutable object (e.g. a
<code class="highlighter-rouge">Map</code>), a <code class="highlighter-rouge">var</code>, and mutate it like so:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">books</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">mutable</span><span class="o">.</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span>
  
  <span class="k">def</span> <span class="n">receive</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">books</span> <span class="o">+=</span> <span class="o">(</span><span class="n">isbn</span> <span class="o">-&gt;</span> <span class="n">title</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Library</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>
</div>

<p>This is a bad idea. There are several reasons for this. First, Scala eschews <code class="highlighter-rouge">var</code>s, they should
only be used when absolutely necessary (read: never). There is also an additional need for
thread-safety for the collection, not because of the <code class="highlighter-rouge">receive</code> method itself. The <code class="highlighter-rouge">receive</code> method
is
<a href="http://doc.akka.io/docs/akka/2.4.11/general/jmm.html">guaranteed to run inside a single thread</a>. However,
an unsuspecting user might still launch a <code class="highlighter-rouge">Future</code> and modify the collection, leading to
unpredictable behaviour. Such concurrent mutations on a <code class="highlighter-rouge">var</code> put strain on the garbage collector,
in fact, it often necessitates the existence of a garbage collector.<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup> Lastly, as with any mutable
state and possible lack of referential transparency, the code can become hard to reason about.</p>

<p>Thankfully, Akka actors offer a possibility to do this completely functionally. The function
<code class="highlighter-rouge">context.become</code> allows an Actor to change its <code class="highlighter-rouge">receive</code> method on-the-fly. In other words, it lets
the Actor change its state and communication model. Here’s the above implemented using this
paradigm:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">active</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>
  
  <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">books</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="c1">// for immutable maps, += returns a new collection
</span>      <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">active</span><span class="o">(</span><span class="n">books</span> <span class="o">+=</span> <span class="o">(</span><span class="n">isbn</span> <span class="o">-&gt;</span> <span class="n">title</span><span class="o">)))</span> 
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">active</code> function returns a new <code class="highlighter-rouge">Receive</code>, receiving the current actor <em>state</em> as its
parameter. Adding logic to it is now easy:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">active</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>
  
  <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">books</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span> <span class="n">title</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">books</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">active</span><span class="o">(</span><span class="n">books</span> <span class="o">+=</span> <span class="o">(</span><span class="n">isbn</span> <span class="o">-&gt;</span> <span class="n">title</span><span class="o">)))</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="s">"Too many books"</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The above code is now thread-safe and doesn’t use mutable collections, but what if our logic gets
more complicated? What if we need to talk to another Actor, or talk to the sender of the message?
This is where we stumble upon a design feature of Akka: <em>all</em> of its Actors are actually compiled
down into a callback-based implementation. There is no guarantee that a <code class="highlighter-rouge">Future</code> launched in a
receive case will be running in the same thread as the next! One could argue that this is not a
feature but a <em>flaw</em>, but I won’t go that far. Hence, code dealing with Futures in Akka actors needs to deal with the unforgiving reality that there is no
guarantee of thread safety. Case in point:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span><span class="o">(</span><span class="n">popReservation</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">active</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>
  
  <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">books</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span> <span class="c1">// as before
</span>    <span class="k">case</span> <span class="nc">AskForBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="n">popReservation</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="n">foreach</span> <span class="o">{</span> <span class="n">i</span> <span class="k">=&gt;</span>
        <span class="c1">// AAH!!!
</span>        <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">active</span><span class="o">(</span><span class="n">books</span> <span class="o">-</span> <span class="n">i</span><span class="o">))</span>
        <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="n">s</span><span class="s">"Here you go: $i"</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre>
</div>

<p>Why am I screaming in the comments? First, as calling <code class="highlighter-rouge">map</code> for our Future launches a new thread, we
have no idea whether <code class="highlighter-rouge">sender()</code> returns the same value in the new thread, and second, we may be
modifying the books collection concurrently with other threads - leaving the garbage collector to
collect our mess. So we strain the GC <em>and</em> risk giving the book to the wrong caller!</p>

<p>Since the actual execution of a Future is left to the execution context, which in the case of Actors
is the <code class="highlighter-rouge">ActorSystem</code>s dispatcher, we may or may not be invoking <code class="highlighter-rouge">sender()</code> in the right thread
— there is simply no guarantee. We can’t reason about it, it has been hidden from us.</p>

<p>To deal with this, Akka has introduced the <code class="highlighter-rouge">pipe</code> pattern, which is an implicit given to Futures
which solves this:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span><span class="o">(</span><span class="n">popReservation</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">active</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>
  
  <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">books</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span> <span class="c1">// as before
</span>    <span class="k">case</span> <span class="nc">AskForBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="c1">// launch another thread
</span>      <span class="k">val</span> <span class="n">reservation</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">popReservation</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">i</span> <span class="k">=&gt;</span>
        <span class="n">s</span><span class="s">"Here you go: $i"</span>
        <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">active</span><span class="o">(</span><span class="n">books</span> <span class="o">-</span> <span class="n">isbn</span><span class="o">))</span> <span class="c1">// AAH!
</span>      <span class="o">}</span>
      <span class="c1">// but sender() is still the same
</span>      <span class="n">reservation</span> <span class="n">pipeTo</span> <span class="n">sender</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Another option is to fix the reference of <code class="highlighter-rouge">sender</code>:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="n">sender</span><span class="o">()</span>
<span class="k">val</span> <span class="n">reservation</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">popReservation</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">i</span> <span class="k">=&gt;</span>
  <span class="n">s</span> <span class="o">!</span> <span class="n">s</span><span class="s">"Here you go: $i"</span>
  <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">active</span><span class="o">(</span><span class="n">books</span> <span class="o">-</span> <span class="n">isbn</span><span class="o">))</span> <span class="c1">// AAH!
</span><span class="o">}</span>
</code></pre>
</div>

<p>Ok, now we’ve fixed <code class="highlighter-rouge">sender()</code>, but what about the <code class="highlighter-rouge">books</code> collection? Let’s add a <code class="highlighter-rouge">PopBook(isbn:
String)</code> case class, and handle that for removals:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span><span class="o">(</span><span class="n">popReservation</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">active</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>
  
  <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">books</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span> <span class="c1">// as before
</span>    <span class="k">case</span> <span class="nc">PopBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">context</span><span class="o">.</span><span class="n">become</span><span class="o">(</span><span class="n">active</span><span class="o">(</span><span class="n">books</span> <span class="o">-</span> <span class="n">isbn</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">AskForBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
      <span class="c1">// launch another thread
</span>      <span class="k">val</span> <span class="n">reservation</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">popReservation</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">i</span> <span class="k">=&gt;</span>
        <span class="n">s</span><span class="s">"Here you go: $i"</span>
        <span class="n">self</span> <span class="o">!</span> <span class="nc">PopBook</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="c1">// but sender() is still the same
</span>      <span class="n">reservation</span> <span class="n">pipeTo</span> <span class="n">sender</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Sending messages to <code class="highlighter-rouge">self</code> is always thread-safe - the reference does not change over time. So, at
this point, it seems clear that making actor code thread-<em>sane</em> involves the use of:</p>

<ul>
  <li>immutable state - call <code class="highlighter-rouge">context.become</code> with a closure over the new actor state,</li>
  <li>converting asynchronous state modifications as messages to be handled later, and</li>
  <li>making sure the <code class="highlighter-rouge">sender()</code> reference is consistent</li>
</ul>

<p>What about complicated states? What if we need to react differently to these messages, e.g., when
the library is closed? I sense that you’re about to mention Akka’s <code class="highlighter-rouge">FSM</code> construct, which
builds a state machine, encapsulating state and transitions to what is essentially syntactic sugar,
and on the surface, seems like a good idea.</p>

<h2 id="enter-akka-fsms">Enter Akka FSMs</h2>

<p>At a closer look, it essentially leads us to repeat the same mistakes as above, and the arguments
against it are argumented <a href="https://github.com/alexandru/scala-best-practices/blob/master/sections/5-actors.md#55-should-not-use-akka-fsm" target="_blank">here</a>. In
summary, it boils down to:</p>

<ol>
  <li>Akka FSM’s is too restrictive. You cannot handle multi-step or complicated state transitions, and
modeling undeterministic behaviour is impossible.</li>
  <li>You are tied to Akka completely, you must use Akka testkit for your tests. Anyone who has worked
with testkit knows this to be a burden.</li>
  <li>State transitions have identity instead of being truly functional, that is, FSMs alter the
<em>current</em> state instead of <em>producing</em> a new one.</li>
</ol>

<p>Moreover, and I think this is the biggest shortcoming, the Akka FSM are finite-state <em>automata</em>
— they are characterised by the state transition function <code class="highlighter-rouge">(Input, State) =&gt; State</code>. Since we
know actors are more about communication than anything else, this model is insufficient, and what we
need is a state machine that can produce <em>output</em>: a finite state <em>transducer</em>. Its state transition
function has the signature <code class="highlighter-rouge">(Input, State) =&gt; (Output, State)</code> - every transition produces an
output, and Scala can model this efficiently:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">trait</span> <span class="nc">FSA</span><span class="o">[</span><span class="kt">State</span>, <span class="kt">Input</span>, <span class="kt">Output</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">transition</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">State</span><span class="o">,</span> <span class="n">i</span><span class="k">:</span> <span class="kt">Input</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Output</span><span class="o">],</span> <span class="nc">State</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>
</div>

<p>With all these flaws, despite being a nice idea at a glance, it’s obvious that for any complicated
logic Akka FSM’s aren’t sufficient.</p>

<p>Let’s envision a radical version of actors, accounting for all the flaws described above:</p>

<ul>
  <li>State transitions should be about producing a new state, i.e. <code class="highlighter-rouge">(Input, State) =&gt; (Output, State)</code>
</li>
  <li>Actor computations will deal with asynchronous code, we must deal with this intelligently</li>
  <li>Keep I/O logic out of actors - the actor only communicates with the external world</li>
  <li>Actors should only mutate their state with with <code class="highlighter-rouge">context.become</code>
</li>
</ul>

<p>The last bullet point is especially important, as it constrains state changes
to be entirely functional, as you can simply make a function <code class="highlighter-rouge">def foo(state:
State): Receive</code>, and keep calling it recursively, by transitioning states
thusly:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">someInput</span><span class="k">:</span> <span class="kt">Input</span> <span class="o">=&gt;</span> <span class="n">context</span> <span class="n">become</span> <span class="n">active</span><span class="o">(</span><span class="n">state</span><span class="o">)</span>
<span class="o">}</span>
</code></pre>
</div>

<p>This idea is not new. Erlang actors have worked like this for actual decades,
and arguments for using this method in Scala can be found left and right, summarized particularly well in
Alexandru Nedelcu’s <a href="https://github.com/alexandru/scala-best-practices/blob/master/sections/5-actors.md#52-should-mutate-state-in-actors-only-with-contextbecome">Scala best practices</a>.</p>

<div class="language-erlang highlighter-rouge">
<pre class="highlight"><code><span class="nf">active</span><span class="p">(</span><span class="nv">Sum</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">receive</span> 
    <span class="p">{</span><span class="nv">From</span><span class="p">,</span> <span class="nv">GetValue</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">From</span> <span class="o">!</span> <span class="nv">Sum</span><span class="p">;</span>
    <span class="p">{</span><span class="n">n</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nf">active</span><span class="p">(</span><span class="nv">Sum</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
  <span class="k">end</span><span class="p">.</span>
</code></pre>
</div>

<p>Putting emphasis on the last point, I’ve come up with a moniker called <em>communicators</em>.</p>

<h2 id="actor-meet-communicator">Actor, meet communicator</h2>

<p>Let’s define the <code class="highlighter-rouge">Communicator</code> trait first independently:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">trait</span> <span class="nc">Communicator</span><span class="o">[</span><span class="kt">State</span>, <span class="kt">Input</span>, <span class="kt">Output</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="cm">/** This is the initial actor state */</span>
  <span class="k">def</span> <span class="n">initial</span><span class="k">:</span> <span class="kt">State</span>

  <span class="cm">/** The state transition function */</span>
  <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">,</span> <span class="n">input</span><span class="k">:</span> <span class="kt">Input</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[(</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Output</span><span class="o">]</span>, <span class="kt">State</span><span class="o">)]</span>

  <span class="cm">/** The output processing function */</span>
  <span class="k">def</span> <span class="n">handle</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">,</span> <span class="n">output</span><span class="k">:</span> <span class="kt">Output</span><span class="o">,</span> <span class="n">origin</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">initial</code> is simply the initial state machine state, <code class="highlighter-rouge">process</code> is the state transition function and
<code class="highlighter-rouge">handle</code> is the function that will deal with dispatching the result of <code class="highlighter-rouge">process</code>. Because we’re
producing content in another thread, we want to make sure the reference of <code class="highlighter-rouge">sender</code> is fixed, and by
using this with the <code class="highlighter-rouge">pipeTo</code> pattern, we get thread safety. Let’s extend the <code class="highlighter-rouge">Actor</code> trait to get
<code class="highlighter-rouge">receive</code></p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">trait</span> <span class="nc">Communicator</span><span class="o">[</span><span class="kt">State</span>, <span class="kt">Input</span>, <span class="kt">Output</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="cm">/** This is the initial actor state */</span>
  <span class="k">def</span> <span class="n">initial</span><span class="k">:</span> <span class="kt">State</span>

  <span class="cm">/** The state transition function */</span>
  <span class="k">def</span> <span class="n">handle</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">,</span> <span class="n">product</span><span class="k">:</span> <span class="kt">Output</span><span class="o">,</span> <span class="n">origin</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>

  <span class="cm">/** The output processing function */</span>
  <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">,</span> <span class="n">input</span><span class="k">:</span> <span class="kt">Input</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[(</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Output</span><span class="o">]</span>, <span class="kt">State</span><span class="o">)]</span>
  
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">active</span><span class="o">(</span><span class="n">initial</span><span class="o">)</span>
  
  <span class="cm">/** I/O handling which the deriving class must implement */</span>
  <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">newState</span><span class="k">:</span> <span class="kt">State</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">active</code> function is the actual output-producing function. The user is left to define three
things:</p>

<ul>
  <li>the initial actor state in <code class="highlighter-rouge">initial</code>
</li>
  <li>the output dispatch function <code class="highlighter-rouge">handle</code>
</li>
  <li>the state transition function <code class="highlighter-rouge">process</code>
</li>
  <li>the <code class="highlighter-rouge">active</code> function which handles input and output</li>
</ul>

<p>To see this in action, first, let’s define the application states.</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">object</span> <span class="nc">Library</span> <span class="o">{</span>
  <span class="c1">// Library state
</span>  <span class="k">case</span> <span class="k">class</span> <span class="nc">LibraryState</span><span class="o">(</span><span class="n">open</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span> <span class="n">books</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span>

  <span class="c1">// Input alphabet
</span>  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">LibraryInput</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">SetOpen</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span>                  <span class="k">extends</span> <span class="nc">Input</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Input</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">GetBook</span><span class="o">(</span><span class="n">isbn</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>                <span class="k">extends</span> <span class="nc">Input</span>

  <span class="c1">// Output alphabet
</span>  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">LibraryOutput</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">SorryWeAreClosed</span>                        <span class="k">extends</span> <span class="nc">Output</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">DoNotHaveIt</span>                             <span class="k">extends</span> <span class="nc">Output</span>
  <span class="k">case</span> <span class="k">object</span> <span class="nc">SorryReserved</span>                           <span class="k">extends</span> <span class="nc">Output</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Book</span><span class="o">(</span><span class="n">isbn</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>        <span class="k">extends</span> <span class="nc">Output</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Reservation</span><span class="o">(</span><span class="n">isbn</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">title</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Output</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The actual state is just a case class: this gives us the nice <code class="highlighter-rouge">copy</code> function for easy updates. Then
we use polymorphism to implement the input and output alphabets. Then we implement the actor itself:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span><span class="o">(</span><span class="n">getReservation</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">Communicator</span><span class="o">[</span><span class="kt">LibraryState</span>, <span class="kt">LibraryInput</span>, <span class="kt">LibraryOutput</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">Library._</span>

  <span class="k">def</span> <span class="n">initial</span> <span class="k">=</span> <span class="nc">State</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">scala</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">immutable</span><span class="o">.</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">newState</span><span class="k">:</span> <span class="kt">LibraryState</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="o">(</span><span class="n">output</span><span class="k">:</span> <span class="kt">LibraryOutput</span><span class="o">,</span> <span class="n">origin</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">handle</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">origin</span><span class="o">)</span>

    <span class="k">case</span> <span class="n">input</span><span class="k">:</span> <span class="kt">LibraryInput</span> <span class="o">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">origin</span> <span class="k">=</span> <span class="n">sender</span><span class="o">()</span>
      <span class="n">process</span><span class="o">(</span><span class="n">newState</span><span class="o">,</span> <span class="n">input</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span>
        <span class="k">case</span> <span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">state</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="n">output</span> <span class="n">foreach</span> <span class="o">{</span> <span class="n">o</span> <span class="k">=&gt;</span>
            <span class="n">self</span> <span class="o">!</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">origin</span><span class="o">)</span>
          <span class="o">}</span>
          <span class="n">self</span> <span class="o">!</span> <span class="n">state</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">,</span> <span class="n">input</span><span class="k">:</span> <span class="kt">Input</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[(</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Output</span><span class="o">]</span>, <span class="kt">State</span><span class="o">)]</span> <span class="k">=</span>
    <span class="n">input</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">SetOpen</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">((</span><span class="nc">None</span><span class="o">,</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">open</span> <span class="k">=</span> <span class="n">o</span><span class="o">)))</span>

      <span class="k">case</span> <span class="o">(</span><span class="nc">GetBook</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">|</span> <span class="nc">AddBook</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">))</span> <span class="k">if</span> <span class="o">!</span><span class="n">state</span><span class="o">.</span><span class="n">open</span> <span class="k">=&gt;</span>
        <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">((</span><span class="nc">Some</span><span class="o">(</span><span class="nc">SorryWeAreClosed</span><span class="o">),</span> <span class="n">state</span><span class="o">))</span>

      <span class="k">case</span> <span class="nc">GetBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">book</span> <span class="k">=</span>
          <span class="k">for</span> <span class="o">{</span>
            <span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">state</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span>
          <span class="o">}</span> <span class="k">yield</span> <span class="o">{</span>
            <span class="n">getReservation</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">reserved</span> <span class="k">=&gt;</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">reserved</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="nc">Book</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)),</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">books</span> <span class="k">=</span> <span class="n">state</span><span class="o">.</span><span class="n">books</span> <span class="o">-</span> <span class="n">isbn</span><span class="o">))</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="nc">SorryReserved</span><span class="o">),</span> <span class="n">state</span><span class="o">)</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>

        <span class="n">book</span> <span class="n">getOrElse</span> <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">((</span><span class="nc">Some</span><span class="o">(</span><span class="nc">DoNotHaveIt</span><span class="o">),</span> <span class="n">state</span><span class="o">))</span>
      <span class="o">}</span>

      <span class="k">case</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">((</span><span class="nc">None</span><span class="o">,</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">books</span> <span class="k">=</span> <span class="n">state</span><span class="o">.</span><span class="n">books</span> <span class="o">+</span> <span class="o">(</span><span class="n">isbn</span> <span class="o">-&gt;</span> <span class="n">title</span><span class="o">))))</span>
    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">handle</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">State</span><span class="o">,</span> <span class="n">output</span><span class="k">:</span> <span class="kt">Output</span><span class="o">,</span> <span class="n">origin</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Future</span> <span class="o">{</span>
      <span class="n">origin</span> <span class="o">!</span> <span class="n">output</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="decoupling-akka">Decoupling Akka</h2>

<p>So, now we’ve made a very thin actor, with little I/O logic inside it, but it’s still an
actor. Let’s decouple it entirely from actor semantics. First, we define a <code class="highlighter-rouge">StateMachine[I, O]</code>
trait:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">trait</span> <span class="nc">StateMachine</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">O</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">I</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[(</span><span class="kt">Option</span><span class="o">[</span><span class="kt">O</span><span class="o">]</span>, <span class="kt">StateMachine</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">O</span><span class="o">])]</span>
<span class="o">}</span>
</code></pre>
</div>

<p>And excise the state logic from the Communicator, moving it to the <code class="highlighter-rouge">State</code> case class:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">LibraryState</span><span class="o">(</span><span class="n">open</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span> <span class="n">books</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">],</span> <span class="n">getReservation</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">])(</span>
    <span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">StateMachine</span><span class="o">[</span><span class="kt">LibraryInput</span>, <span class="kt">LibraryOutput</span><span class="o">]</span> <span class="o">{</span>
    
  <span class="k">def</span> <span class="n">process</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">LibraryInput</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[(</span><span class="kt">Option</span><span class="o">[</span><span class="kt">LibraryOutput</span><span class="o">]</span>, <span class="kt">LibraryState</span><span class="o">)]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">input</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">SetOpen</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">((</span><span class="nc">None</span><span class="o">,</span> <span class="n">copy</span><span class="o">(</span><span class="n">open</span> <span class="k">=</span> <span class="n">o</span><span class="o">)))</span>

      <span class="k">case</span> <span class="o">(</span><span class="nc">GetBook</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">|</span> <span class="nc">AddBook</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">))</span> <span class="k">if</span> <span class="o">!</span><span class="n">open</span> <span class="k">=&gt;</span>
        <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">((</span><span class="nc">Some</span><span class="o">(</span><span class="nc">SorryWeAreClosed</span><span class="o">),</span> <span class="n">copy</span><span class="o">()))</span>

      <span class="k">case</span> <span class="nc">GetBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">book</span> <span class="k">=</span>
          <span class="k">for</span> <span class="o">{</span>
            <span class="n">title</span> <span class="k">&lt;-</span> <span class="n">books</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span>
          <span class="o">}</span> <span class="k">yield</span> <span class="o">{</span>
            <span class="n">getReservation</span><span class="o">(</span><span class="n">isbn</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">reserved</span> <span class="k">=&gt;</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">reserved</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="nc">Book</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)),</span> <span class="n">copy</span><span class="o">(</span><span class="n">books</span> <span class="k">=</span> <span class="n">books</span> <span class="o">-</span> <span class="n">isbn</span><span class="o">))</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="nc">SorryReserved</span><span class="o">),</span> <span class="n">copy</span><span class="o">())</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>

        <span class="n">book</span> <span class="n">getOrElse</span> <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">((</span><span class="nc">Some</span><span class="o">(</span><span class="nc">DoNotHaveIt</span><span class="o">),</span> <span class="n">copy</span><span class="o">()))</span>
      <span class="o">}</span>

      <span class="k">case</span> <span class="nc">AddBook</span><span class="o">(</span><span class="n">isbn</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">((</span><span class="nc">None</span><span class="o">,</span> <span class="n">copy</span><span class="o">(</span><span class="n">books</span> <span class="k">=</span> <span class="n">books</span> <span class="o">+</span> <span class="o">(</span><span class="n">isbn</span> <span class="o">-&gt;</span> <span class="n">title</span><span class="o">))))</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>You may be wondering: wait, where’s the <code class="highlighter-rouge">handle</code> implementation? We kept that out from the state
machine class since it’s not its responsibility - so we keep that in the Communicator:</p>

<div class="language-scala highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Library</span><span class="o">(</span><span class="n">getReservation</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">Communicator</span><span class="o">[</span><span class="kt">LibraryInput</span>, <span class="kt">LibraryOutput</span>, <span class="kt">LibraryState</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">context.dispatcher</span>

  <span class="k">def</span> <span class="n">initial</span> <span class="k">=</span> <span class="nc">LibraryState</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">scala</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">immutable</span><span class="o">.</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="n">getReservation</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">handle</span><span class="o">(</span><span class="n">output</span><span class="k">:</span> <span class="kt">LibraryOutput</span><span class="o">,</span> <span class="n">origin</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">!</span> <span class="n">output</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">newState</span><span class="k">:</span> <span class="kt">LibraryState</span><span class="o">)</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="o">(</span><span class="n">output</span><span class="k">:</span> <span class="kt">LibraryOutput</span><span class="o">,</span> <span class="n">origin</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">handle</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">origin</span><span class="o">)</span>

    <span class="k">case</span> <span class="n">state</span><span class="k">:</span> <span class="kt">LibraryState</span> <span class="o">=&gt;</span> <span class="n">context</span> <span class="n">become</span> <span class="n">active</span><span class="o">(</span><span class="n">state</span><span class="o">)</span>

    <span class="k">case</span> <span class="n">input</span><span class="k">:</span> <span class="kt">LibraryInput</span> <span class="o">=&gt;</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">origin</span> <span class="k">=</span> <span class="n">sender</span><span class="o">()</span>
      <span class="n">newState</span><span class="o">.</span><span class="n">process</span><span class="o">(</span><span class="n">input</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span>
        <span class="k">case</span> <span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">state</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
          <span class="n">output</span> <span class="n">foreach</span> <span class="o">{</span> <span class="n">o</span> <span class="k">=&gt;</span> 
            <span class="n">self</span> <span class="o">!</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">origin</span><span class="o">)</span>
          <span class="o">}</span>
          <span class="n">self</span> <span class="o">!</span> <span class="n">state</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre>
</div>

<p>So, all state is kept neatly in a separate entity that’s entirely unit testable in its own right
without having to rely on Akka testkit or the like – input and output dispatch and state
transitions are done in the <code class="highlighter-rouge">active</code> method.</p>

<p>I know the state case class manipulation introduces more boilerplate, but as long as that
boilerplate isn’t complicated, I think this is a fair compromise. Plus, one can
use <a href="https://github.com/julien-truffaut/Monocle">lenses</a> to remove some of the boilerplate, e.g., 
by defining handy update functions. One could cook up something doggedly interesting using <a href="http://typelevel.org/cats">Cats</a> and
<code class="highlighter-rouge">StateT</code> - as long as you provide a function of the kind <code class="highlighter-rouge">(I, S) =&gt; (Option[O], S)</code>, the sky is the limit.</p>

<p><em>Thanks to Jaakko Pallari (<a href="https://github.com/jkpl" class="user-mention">@jkpl</a>) for previewing this.</em></p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>This is actually false, as Aaron Turon, a core Rust developer, proves in his article about <a href="demonstrates">getting lock-free structures without garbage collection</a>. <a href="#fnref:1" class="reversefootnote">↩</a></p>
    </li>
  </ol>
</div>

         <hr> 
    </article>
    
    
    
    


    <nav class="pagination" role="pagination">
    
    <span class="page-number"> Page 1 of 4 </span>
     
        <a class="older-posts" href="/page2/" title="Next Page">Older Posts »</a>
     
</nav>
        </div>
        <div class="col-sm-3">
            <div class="card" style="border-color: transparent; background-color: #f8f8f8;">
    <img class="card-img-top" style="width: 100%" src="/images/me.jpg">
    <div class="card-block">
        <h4 class="card-title">Antoine Kalmbach</h4>
        <h6 class="card-subtitle"><a class="text-muted" href="https://github.com/ane">@ane</a></h6>
        <p class="m-t-1 card-text">I'm a software engineer. This is a blog. It's about software, life, and other silly things.</p>
    </div>
</div>
<div class="card card-block m-b-0" style="border-color: transparent;">
    <h3 class="card-title">Find me</h3>
    <h5>
        <a class="card-link" href="https://github.com/ane"><i class="fa fa-github"></i> Github</a>
    </h5>
    <h5>
        <a class="card-link" href="https://twitter.com/anewtf"><i class="fa fa-twitter-square"></i> Twitter</a>
    </h5>
    <h5>
        <a class="card-link" href="https://twitter.com/anewtf"><i class="fa fa-linkedin-square"></i> LinkedIn</a>
    </h5>
</div>
<div class="card card-block p-t-0" style="border-color: transparent;">
    <h3 class="card-title">Archives</h3>
    <ul class="list-unstyled m-b-0">

    
    
    
    

    
    <li>
        <a href="/archive.html#2016-October-ref">October 2016</a>
    </li>
    

    
        
    
    
    

    
    
    
    

    

    
        
    
    
    

    
    
    
    

    

    
        
    
    <li>
        <a href="/archive.html#2016-October-ref">March 2016</a>
    </li>
    
    
    

    
    
    
    

    

    
        
    
    
    

    
    
    
    

    

    
        
    
    <li>
        <a href="/archive.html#2016-March-ref">January 2016</a>
    </li>
    
    
    

    
    
    
    

    

    
        
    
    
    

    
    
    
    

    

    
        
    
    
    

    
    
    
    

    

    
    
    <li>
        <a href="/archive.html#2016-January-ref">December 2015</a>
    </li>
    
    

    
    
    
    

    

    
        
    
    <li>
        <a href="/archive.html#2015-December-ref">January 2015</a>
    </li>
    
    
    

    
    
    
    

    

    
    

</ul>

</div>

        </div>
    </div>
    
</div>

                </div>
                
                <footer>
                    <hr>
                    <address>
                        Copyright © 2016 <a href="">Antoine Kalmbach</a> under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>.
                    </address>
                </footer>
            </div>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js" integrity="sha384-THPy051/pYDQGanwU6poAc/hOdQxjnOEXzbT+OuUAFqNqFjL+4IGLBgCJC3ZOShY" crossorigin="anonymous"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.2.0/js/tether.min.js" integrity="sha384-Plbmg8JY28KFelvJVai01l8WyZzrYWG825m+cZ0eDDS1f7d/js6ikvy1+X+guPIB" crossorigin="anonymous"></script>
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/js/bootstrap.min.js" integrity="sha384-VjEeINv9OSwtWFLAtmc4JCtEJXXBub00gtSnszmspDLCtC0I4z4nqz7rEFbIZLLU" crossorigin="anonymous"></script>
            <script src="/assets/hyphenator.js" type="text/javascript"></script>
            <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
            </script>
            <script src="https://use.fontawesome.com/2772baba9e.js"></script>
            <script src="/assets/hylo.js" type="text/javascript"></script>
            <!-- Google Analytics Tracking code -->
            <script type="text/javascript">

             var _gaq = _gaq || [];
             _gaq.push(['_setAccount', 'UA-58162697-1']);
             _gaq.push(['_trackPageview']);

             (function() {
                 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
             })();

            </script>   
        </div>
        
        
    </body>
</html>
